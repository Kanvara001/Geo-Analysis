name: GEE Pipeline â€” Test Integration

on:
  workflow_dispatch:

jobs:
  test-integration:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r gee-pipeline/requirements.txt

    # ----------------------------------------------------
    # ğŸ”‘ Load service key â€” SAFE JSON (printf à¹„à¸¡à¹ˆà¸—à¸³ JSON à¹à¸•à¸)
    # ----------------------------------------------------
    - name: Create service-key.json
      env:
        SERVICE_KEY_JSON: ${{ secrets.SERVICE_KEY_JSON }}
      run: |
        mkdir -p gee-pipeline
        printf "%s" "$SERVICE_KEY_JSON" > gee-pipeline/service-key.json

    # ----------------------------------------------------
    # ğŸ” Validate JSON (à¸ªà¸³à¸„à¸±à¸!)
    # ----------------------------------------------------
    - name: Validate service-key.json
      run: |
        echo "Validating service-key.json..."
        python - << 'EOF'
import json
with open("gee-pipeline/service-key.json") as f:
    json.load(f)
print("JSON OK âœ“")
EOF

    # ----------------------------------------------------
    # ğŸŸ¦ STEP 1 â€” Poll + Download CSV + Convert Parquet
    # ----------------------------------------------------
    - name: Run poll_download_convert
      env:
        GOOGLE_APPLICATION_CREDENTIALS: gee-pipeline/service-key.json
        GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
      run: |
        echo "=== Running poll_download_convert.py ==="
        python gee-pipeline/scripts/poll_download_convert.py

    # ----------------------------------------------------
    # ğŸ“‚ Check raw_parquet output
    # ----------------------------------------------------
    - name: List raw_parquet output
      run: |
        echo "=== RAW PARQUET OUTPUT ==="
        ls -R gee-pipeline/outputs/raw_parquet || echo "No raw_parquet folder found"

    # ----------------------------------------------------
    # ğŸŸ§ STEP 2 â€” Clean parquet files
    # ----------------------------------------------------
    - name: Run clean_raw_data
      run: |
        echo "=== Running clean_raw_data.py ==="
        python gee-pipeline/scripts/clean_raw_data.py

    # ----------------------------------------------------
    # ğŸ“‚ Check clean output
    # ----------------------------------------------------
    - name: List cleaned output
      run: |
        echo "=== CLEAN OUTPUT ==="
        ls -R gee-pipeline/outputs/clean || echo "No clean folder found"

    # ----------------------------------------------------
    # ğŸ‰ FINAL â€” Summary
    # ----------------------------------------------------
    - name: Summary
      run: |
        echo "==================== SUMMARY ===================="
        echo "1) JSON OK"
        echo "2) poll_download_convert.py ran"
        echo "3) raw_parquet generated (if any files exist)"
        echo "4) clean_raw_data.py ran"
        echo "5) No files committed â€” test only"
        echo "================================================="
