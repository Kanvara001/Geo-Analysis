name: GEE Pipeline TEST (Fast)

on:
  workflow_dispatch:
    inputs:
      variable:
        description: "Choose variable to test"
        required: true
        type: choice
        options:
          - NDVI
          - LST
          - SoilMoisture
          - Rainfall
          - FireCount

jobs:
  poll-convert-clean-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r gee-pipeline/requirements.txt

    - name: Create service-key.json
      env:
        SERVICE_KEY_JSON: ${{ secrets.SERVICE_KEY_JSON }}
      run: |
        echo "$SERVICE_KEY_JSON" > gee-pipeline/service-key.json

    - name: Download from GCS & Convert to Parquet (TEST MODE)
      env:
        GOOGLE_APPLICATION_CREDENTIALS: gee-pipeline/service-key.json
        GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
      run: |
        python gee-pipeline/scripts/poll_download_convert.py --var ${{ github.event.inputs.variable }} --limit 1

    - name: Clean raw parquet (TEST MODE)
      run: |
        python gee-pipeline/scripts/clean_raw_data.py ${{ github.event.inputs.variable }}

    - name: Show output tree
      run: |
        echo "===== RAW ====="
        ls -R gee-pipeline/outputs/raw_parquet || true
        echo "===== CLEAN ====="
        ls -R gee-pipeline/outputs/clean || true
