name: GEE Incremental Monthly Pipeline (AUTO)

on:
  # schedule:
  #   - cron: "0 0 2 * *"   # âŒ à¸›à¸´à¸” cron à¹„à¸§à¹‰à¸à¹ˆà¸­à¸™ à¸•à¸­à¸™ debug
  workflow_dispatch:

jobs:
  incremental-pipeline:
    runs-on: ubuntu-latest

    env:
      PIPELINE_MODE: AUTO

    steps:
    # ----------------------------------------------------
    # ðŸ“¦ CHECKOUT
    # ----------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # ----------------------------------------------------
    # ðŸ PYTHON
    # ----------------------------------------------------
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    # ----------------------------------------------------
    # ðŸ“š DEPENDENCIES
    # ----------------------------------------------------
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r gee-pipeline/requirements.txt

    # ----------------------------------------------------
    # ðŸ” SERVICE ACCOUNT KEY (Earth Engine)
    # ----------------------------------------------------
    - name: Create service-key.json
      env:
        GEE_SERVICE_ACCOUNT_KEY: ${{ secrets.GEE_SERVICE_ACCOUNT_KEY }}
      run: |
        printf '%s' "$GEE_SERVICE_ACCOUNT_KEY" > gee-pipeline/service-key.json
        
    - name: DEBUG service key
      run: |
        python - <<EOF
        import json
        with open("gee-pipeline/service-key.json") as f:
          json.load(f)
        print("âœ… JSON OK")
        EOF

    # ----------------------------------------------------
    # ðŸš€ EXPORT (AUTO â€“ incremental only)
    # ----------------------------------------------------
    - name: Export NEW month only
      env:
        SERVICE_ACCOUNT: gee-runner@geo-analysis-472713.iam.gserviceaccount.com
        GOOGLE_APPLICATION_CREDENTIALS: gee-pipeline/service-key.json
        GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
      run: |
        python gee-pipeline/scripts_auto/gee_export_tasks.py

    # ----------------------------------------------------
    # â¬ POLL + DOWNLOAD + CONVERT
    # ----------------------------------------------------
    # - name: Poll & Download from GCS
    #   env:
    #     GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
    #     GOOGLE_APPLICATION_CREDENTIALS: gee-pipeline/service-key.json
    #   run: |
    #     python gee-pipeline/scripts_auto/poll_download_convert.py

    # ----------------------------------------------------
    # ðŸ§¹ CLEAN (NEW MONTH ONLY)
    # ----------------------------------------------------
    # - name: Clean new data
    #   run: |
    #     python gee-pipeline/scripts_auto/clean_raw_data.py

    # ----------------------------------------------------
    # ðŸ”— MERGE (APPEND ONLY)
    # ----------------------------------------------------
    # - name: Merge append
    #   run: |
    #     python gee-pipeline/scripts_auto/merge_cleaned.py

    # ----------------------------------------------------
    # ðŸ’‰ FINAL FILL AFTER MERGE
    # ----------------------------------------------------
    # - name: Final fill
    #   run: |
    #     python gee-pipeline/scripts_auto/final_fill_after_merge.py

    # ----------------------------------------------------
    # ðŸ’¾ COMMIT RESULT
    # ----------------------------------------------------
    # - name: Commit AUTO pipeline result
    #   run: |
    #     git config --global user.name "github-actions"
    #     git config --global user.email "github-actions@github.com"
    #     git add gee-pipeline/outputs
    #     git commit -m "AUTO: update monthly dataset" || echo "No changes"
    #     git push
