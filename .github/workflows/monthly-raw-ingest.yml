name: GEE Incremental Monthly Pipeline (AUTO)

on:
  # schedule:
  #   - cron: "0 0 2 * *"   # ‚ùå ‡∏õ‡∏¥‡∏î cron ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏ï‡∏≠‡∏ô debug
  workflow_dispatch:

jobs:
  incremental-pipeline:
    runs-on: ubuntu-latest

    env:
      PIPELINE_MODE: AUTO

    steps:
    # ----------------------------------------------------
    # üì¶ CHECKOUT
    # ----------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # ----------------------------------------------------
    # üêç PYTHON
    # ----------------------------------------------------
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    # ----------------------------------------------------
    # üìö DEPENDENCIES
    # ----------------------------------------------------
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r gee-pipeline/requirements.txt

    # ----------------------------------------------------
    # üîê SERVICE ACCOUNT KEY (Earth Engine)
    # ----------------------------------------------------
    - name: Create service-key.json
      run: |
        echo "${{ secrets.GEE_SERVICE_ACCOUNT_KEY }}" > gee-pipeline/service-key.json

    # ----------------------------------------------------
    # üöÄ EXPORT (AUTO ‚Äì incremental only)
    # ----------------------------------------------------
    - name: Export NEW month only
      env:
        SERVICE_ACCOUNT: gee-runner@geo-analysis-472713.iam.gserviceaccount.com
        GOOGLE_APPLICATION_CREDENTIALS: gee-pipeline/service-key.json
        GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
      run: |
        python gee-pipeline/scripts_auto/gee_export_tasks.py

    # ----------------------------------------------------
    # ‚è¨ POLL + DOWNLOAD + CONVERT
    # ----------------------------------------------------
    # - name: Poll & Download from GCS
    #   env:
    #     GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
    #     GOOGLE_APPLICATION_CREDENTIALS: gee-pipeline/service-key.json
    #   run: |
    #     python gee-pipeline/scripts_auto/poll_download_convert.py

    # ----------------------------------------------------
    # üßπ CLEAN (NEW MONTH ONLY)
    # ----------------------------------------------------
    # - name: Clean new data
    #   run: |
    #     python gee-pipeline/scripts_auto/clean_raw_data.py

    # ----------------------------------------------------
    # üîó MERGE (APPEND ONLY)
    # ----------------------------------------------------
    # - name: Merge append
    #   run: |
    #     python gee-pipeline/scripts_auto/merge_cleaned.py

    # ----------------------------------------------------
    # üíâ FINAL FILL AFTER MERGE
    # ----------------------------------------------------
    # - name: Final fill
    #   run: |
    #     python gee-pipeline/scripts_auto/final_fill_after_merge.py

    # ----------------------------------------------------
    # üíæ COMMIT RESULT
    # ----------------------------------------------------
    # - name: Commit AUTO pipeline result
    #   run: |
    #     git config --global user.name "github-actions"
    #     git config --global user.email "github-actions@github.com"
    #     git add gee-pipeline/outputs
    #     git commit -m "AUTO: update monthly dataset" || echo "No changes"
    #     git push
