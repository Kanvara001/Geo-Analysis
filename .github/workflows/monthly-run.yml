name: Monthly GEE Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 2 * *"   # ทุกวันที่ 2 เวลา 03:00 UTC (10:00 ไทย) -- ตามที่คุณต้องการ

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Write service account key
        # Note: store raw JSON in secret GEE_SERVICE_KEY (or store base64 and change decoding here)
        run: |
          mkdir -p gee-pipeline
          echo "${{ secrets.GEE_SERVICE_KEY }}" > gee-pipeline/service-key.json
          # optional: ensure newline correctness
          sed -i 's/\r$//' gee-pipeline/service-key.json
          ls -l gee-pipeline/service-key.json

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r gee-pipeline/requirements.txt

      - name: Export RAW data from GEE -> GCS
        env:
          SERVICE_ACCOUNT: ${{ secrets.GEE_SERVICE_EMAIL }}
          KEY_PATH: gee-pipeline/service-key.json
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
          TAMBON_ASSET: ${{ secrets.TAMBON_ASSET }}
          START_YEAR: 2015
          END_YEAR: 2024
        run: |
          python gee-pipeline/scripts/gee_export_tasks.py

      - name: Poll GCS, download CSVs and convert to Parquet
        env:
          SERVICE_ACCOUNT: ${{ secrets.GEE_SERVICE_EMAIL }}
          KEY_PATH: gee-pipeline/service-key.json
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
        run: |
          python gee-pipeline/scripts/poll_download_convert.py

      - name: Clean RAW -> produce monthly cleaned combined
        run: |
          python gee-pipeline/scripts/clean_raw_data.py

      - name: Commit cleaned outputs
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add gee-pipeline/outputs || true
          git commit -m "Update cleaned monthly data" || echo "No changes"
          git push || echo "Push failed (maybe no permission)"
