name: Monthly GEE Data Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"   # Run monthly on the 1st

jobs:
  pipeline:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1) Checkout repo
      # -----------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      # -----------------------------
      # 2) Setup Python
      # -----------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # -----------------------------
      # 3) Install dependencies
      # -----------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r gee-pipeline/requirements.txt

      # -----------------------------
      # 4) Authenticate Google Cloud
      # -----------------------------
      - name: Google Cloud Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_KEY }}

      # -----------------------------
      # 5) Auto-clean bucket BEFORE exporting new data
      # -----------------------------
      - name: Auto-clean GCS bucket
        run: |
          echo "üßπ Cleaning old files in bucket..."
          gsutil -m rm -r gs://${{ secrets.GCS_BUCKET }}/raw_export/** || true
          gsutil -m rm -r gs://${{ secrets.GCS_BUCKET }}/archive/** || true
        shell: bash

      # -----------------------------
      # 6) Run GEE Export Tasks
      # -----------------------------
      - name: Run export from GEE
        run: python gee-pipeline/scripts/gee_export_tasks.py

      # -----------------------------
      # 7) Poll + Download + Convert
      # -----------------------------
      - name: Poll, download, convert
        run: python gee-pipeline/scripts/poll_download_convert.py
        env:
          GOOGLE_APPLICATION_CREDENTIALS: gee-pipeline/service-key.json
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}

      # -----------------------------
      # 8) Clean & Merge Data
      # -----------------------------
      - name: Clean & merge
        run: python gee-pipeline/scripts/clean_raw_data.py

      # -----------------------------
      # 9) Create Pull Request
      # -----------------------------
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: Monthly update: $(date)
          branch: monthly-update
          delete-branch: true
          title: Monthly GEE Update ‚Äî $(date)
          body: |
            ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‚úî  
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô merge  
          labels: automated, monthly
          token: ${{ secrets.GITHUB_TOKEN }}
