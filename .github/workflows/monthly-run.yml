name: GEE Monthly Pipeline

on:
  schedule:
    - cron: "0 3 2 * *"    # รันทุกวันที่ 2 เวลา 03:00 UTC (10:00 ไทย)
  workflow_dispatch:        # สามารถกดรันเองได้

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # 1) Checkout Repo
      # -------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v3

      # -------------------------------
      # 2) Setup Python
      # -------------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # -------------------------------
      # 3) Install Dependencies
      # -------------------------------
      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r gee-pipeline/requirements.txt

      # -------------------------------
      # 4) Create Service Account Key File
      # -------------------------------
      - name: Setup Service Account Key
        run: |
          mkdir -p gee-pipeline/config
          echo "${{ secrets.GEE_SERVICE_KEY }}" > gee-pipeline/config/service_key.json

      # -------------------------------
      # 5) Run RAW Export Tasks (GEE → GCS)
      # -------------------------------
      - name: Export RAW Data Tasks
        run: |
          python gee-pipeline/scripts/gee_export_tasks.py

      # -------------------------------
      # 6) Poll Finished Tasks → Download → Convert Parquet
      # -------------------------------
      - name: Poll & Convert RAW Data
        run: |
          python gee-pipeline/scripts/poll_download_convert.py

      # -------------------------------
      # 7) Clean RAW Data → Combined Final Output
      # -------------------------------
      - name: Clean & Combine RAW Data
        run: |
          python gee-pipeline/scripts/clean_raw_data.py

      # -------------------------------
      # 8) Commit updated outputs back to repo
      # -------------------------------
      - name: Commit Updated Output
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add gee-pipeline/outputs/*
          git commit -m "Update monthly data" || echo "No changes to commit"
          git push
