name: Monthly GEE Pipeline

on:
  schedule:
    - cron: "0 2 2 * *"    # ทุกวันที่ 2 เวลา 02:00 UTC
  workflow_dispatch:

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create service key file
        run: |
          echo "$SERVICE_KEY_JSON" > gee-pipeline/service-key.json

        env:
          SERVICE_KEY_JSON: ${{ secrets.SERVICE_KEY_JSON }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -r gee-pipeline/requirements.txt

      - name: Run Export Tasks
        run: |
          python gee-pipeline/scripts/gee_export_tasks.py
        env:
          SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT }}
          GOOGLE_APPLICATION_CREDENTIALS: gee-pipeline/service-key.json
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}

      - name: Poll, download, convert
        run: |
          python gee-pipeline/scripts/poll_download_convert.py

      - name: Clean data
        run: |
          python gee-pipeline/scripts/clean_raw_data.py
