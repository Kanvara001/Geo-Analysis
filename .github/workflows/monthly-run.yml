name: GEE Pipeline (Poll + Clean Only)

on:
  workflow_dispatch:   # ‚úÖ ‡∏£‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

jobs:
  poll-convert-clean:
    runs-on: ubuntu-latest
    timeout-minutes: 600   # ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô timeout

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r gee-pipeline/requirements.txt

    - name: Create service-key.json
      env:
        SERVICE_KEY_JSON: ${{ secrets.SERVICE_KEY_JSON }}
      run: |
        echo "$SERVICE_KEY_JSON" > gee-pipeline/service-key.json

    - name: DEBUG ‚Äî Show generated JSON
      run: |
        echo "----- JSON START -----"
        cat gee-pipeline/service-key.json
        echo "----- JSON END -----"

    # ‚ùå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô export
    # - name: Run Export Script (GEE ‚Üí GCS)
    #   env:
    #     SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT }}
    #     GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
    #     GOOGLE_APPLICATION_CREDENTIALS: gee-pipeline/service-key.json
    #   run: |
    #     python gee-pipeline/scripts/gee_export_tasks.py

    - name: Debug ‚Äî List files in GCS bucket
      env:
        GOOGLE_APPLICATION_CREDENTIALS: gee-pipeline/service-key.json
        GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
      run: |
        python - <<EOF
from google.cloud import storage
import os

client = storage.Client()
bucket = client.bucket(os.environ["GCS_BUCKET"])

print("üìÅ Files in raw_export/:")
for b in bucket.list_blobs(prefix="raw_export/"):
    print(" -", b.name)
EOF

    - name: Download from GCS & Convert to Parquet
      env:
        GOOGLE_APPLICATION_CREDENTIALS: gee-pipeline/service-key.json
        GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
      run: |
        python gee-pipeline/scripts/poll_download_convert.py

    - name: Clean Raw Data
      run: |
        python gee-pipeline/scripts/clean_raw_data.py

    - name: Commit Cleaned Data to Repo
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        git add .
        git commit -m "Automated cleaning update" || echo "No changes to commit"
        git push
