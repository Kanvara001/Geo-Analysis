name: Monthly GEE Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    env:
      SERVICE_ACCOUNT: "gee-runner@geo-analysis-472713.iam.gserviceaccount.com"
      GCS_BUCKET: "geo-analysis-472713-bucket"
      GOOGLE_APPLICATION_CREDENTIALS: gee-pipeline/service-key.json

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: 3.10

      - name: Create service account key
        run: |
          echo "${{ secrets.SERVICE_KEY_JSON }}" > gee-pipeline/service-key.json

      - name: Install dependencies
        run: |
          pip install -r gee-pipeline/requirements.txt

      - name: Run Export Tasks
        run: |
          python gee-pipeline/scripts/gee_export_tasks.py

      - name: Poll Downloads
        run: |
          python gee-pipeline/scripts/poll_download_convert.py

      - name: Clean Raw Data
        run: |
          python gee-pipeline/scripts/clean_raw_data.py
