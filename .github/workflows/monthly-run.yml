name: Monthly GEE Data Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"   # Run on 1st of each month

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
    # --------------------------
    # 1) Checkout Repo
    # --------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # --------------------------
    # 2) Setup Python
    # --------------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        pip install -r gee-pipeline/requirements.txt

    # --------------------------
    # 3) Activate Google Auth
    # --------------------------
    - name: Set up Google Cloud authentication
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - name: Install gcloud SDK
      uses: google-github-actions/setup-gcloud@v2

    # --------------------------
    # 4) üßπ Auto-Clean Bucket ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà
    # --------------------------
    - name: Auto-clean raw_export in bucket
      run: |
        echo "üîç Checking & cleaning bucket: ${{ secrets.GCS_BUCKET }}"
        gsutil -m rm -f gs://${{ secrets.GCS_BUCKET }}/raw_export/** || true
        echo "‚úî Bucket cleaned successfully."

    # --------------------------
    # 5) ‡∏™‡∏£‡πâ‡∏≤‡∏á GEE Export Tasks (firecount/lst/ndvi/rain/soil)
    # --------------------------
    - name: Run GEE export tasks
      run: |
        python gee-pipeline/scripts/gee_export_tasks.py
      env:
        GOOGLE_APPLICATION_CREDENTIALS: gee-pipeline/service-key.json
        GCS_BUCKET: ${{ secrets.GCS_BUCKET }}

    # --------------------------
    # 6) Poll + Download + Convert (geojson ‚Üí Parquet)
    # --------------------------
    - name: Poll, download & convert
      run: |
        python gee-pipeline/scripts/poll_download_convert.py
      env:
        GOOGLE_APPLICATION_CREDENTIALS: gee-pipeline/service-key.json
        GCS_BUCKET: ${{ secrets.GCS_BUCKET }}

    # --------------------------
    # 7) Clean raw data ‚Üí monthly_clean.csv
    # --------------------------
    - name: Clean raw exported data
      run: |
        python gee-pipeline/scripts/clean_raw_data.py

    # --------------------------
    # 8) Create Pull Request
    # --------------------------
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        commit-message: "Monthly update: $(date)"
        branch: monthly-update
        delete-branch: true
        title: "Monthly GEE Update ‚Äî $(date)"
        body: |
          ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‚úî  
          ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô merge  
        labels: automated, monthly
        token: ${{ secrets.GITHUB_TOKEN }}
        committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
        author: Kanvara001 <173020456+Kanvara001@users.noreply.github.com>
