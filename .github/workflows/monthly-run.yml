name: Monthly Update

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"

jobs:
  run-monthly:
    runs-on: ubuntu-latest

    steps:

      # ------------------------------------------------------------
      # 1) Checkout repo
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2) Authenticate with Google Cloud using service-key.json
      # ------------------------------------------------------------
      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # ------------------------------------------------------------
      # 3) Install gcloud
      # ------------------------------------------------------------
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # ------------------------------------------------------------
      # 4) Auto-clean bucket BEFORE running new export
      # ------------------------------------------------------------
      - name: Auto-clean old raw_export from GCS
        run: |
          echo "üßπ Cleaning GCS bucket old files..."
          gsutil -m rm -r gs://${{ secrets.GCS_BUCKET }}/raw_export/** || true
          gsutil -m rm -r gs://${{ secrets.GCS_BUCKET }}/archive/** || true
          echo "‚úî Cleanup completed"

      # ------------------------------------------------------------
      # 5) Set up Python
      # ------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ------------------------------------------------------------
      # 6) Install Python dependencies
      # ------------------------------------------------------------
      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # ------------------------------------------------------------
      # 7) Run GEE export tasks
      # ------------------------------------------------------------
      - name: Run GEE export tasks
        run: python gee-pipeline/scripts/gee_export_tasks.py

      # ------------------------------------------------------------
      # 8) Poll, download, convert to Parquet
      # ------------------------------------------------------------
      - name: Poll & download GCS ‚Üí parquet
        env:
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
          GOOGLE_APPLICATION_CREDENTIALS: gee-pipeline/service-key.json
        run: python gee-pipeline/scripts/poll_download_convert.py

      # ------------------------------------------------------------
      # 9) Clean raw data & merge
      # ------------------------------------------------------------
      - name: Clean raw data
        run: python gee-pipeline/scripts/clean_raw_data.py

      # ------------------------------------------------------------
      # 10) Create Pull Request with updated files
      # ------------------------------------------------------------
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: Monthly update: $(date)
          title: Monthly GEE Update ‚Äî $(date)
          body: ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‚úî \
                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô merge
          labels: automated, monthly
          branch: monthly-update
          delete-branch: true
