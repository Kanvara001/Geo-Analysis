name: GEE Monthly Pipeline

on:
  schedule:
    - cron: "0 3 2 * *"     # รันทุกวันที่ 2 เวลา 03:00 UTC (10:00AM เวลาไทย)
  workflow_dispatch:        # สามารถกดรันเองได้

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      # --------------------------
      # 1) Checkout Repo
      # --------------------------
      - name: Checkout Repository
        uses: actions/checkout@v3

      # --------------------------
      # 2) Setup Python
      # --------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # --------------------------
      # 3) Install Dependencies
      # --------------------------
      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # --------------------------
      # 4) Create Service Account Key File
      # --------------------------
      - name: Setup Service Account Key
        run: |
          mkdir -p config
          echo "${{ secrets.GEE_SERVICE_KEY }}" > config/service_key.json

      # --------------------------
      # 5) Export RAW Data from GEE → GCS
      # --------------------------
      - name: Export RAW Data Tasks
        run: |
          python scripts/gee_export_tasks.py

      # --------------------------
      # 6) Poll Tasks → Download CSV → Convert to Parquet
      # --------------------------
      - name: Poll & Convert RAW Data
        run: |
          python scripts/poll_download_convert.py

      # --------------------------
      # 7) Clean RAW Data → Combined (monthly)
      # --------------------------
      - name: Clean & Combine RAW Data
        run: |
          python scripts/clean_raw_data.py

      # --------------------------
      # 8) Commit Results Back to Repo
      # --------------------------
      - name: Commit Updated Output
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add outputs/*
          git commit -m "Update monthly data" || echo "No changes to commit"
          git push
